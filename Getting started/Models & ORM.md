# Models & ORM

 - [Introduction](#introduction)
 - [Basic usage](#basic-usage)
 - [Insert, Update, Delete](#insert-update-delete)
 - [Associations](#associations)

## Introduction

Quorra makes connecting with databases and running queries extremely simple. Quorra comes installed with a powerful
ORM/ODM called [Waterline](https://github.com/balderdashy/waterline), a datastore-agnostic tool that dramatically
simplifies interaction with one or more databases. It provides an abstraction layer on top of the underlying
database, allowing you to easily query and manipulate your data without writing vendor-specific integration code.

Before getting started, be sure to configure a database connection in app/config/database.js.

## Basic usage

To get started, create a waterline model. Models live in the app/models directory of your application.

### Defining An Waterline Model

```javascript
// path: app/models/user.js
var User = {
    attributes: {
       ...
    }
};

module.exports = User;
```
#### tableName

Note that we did not tell Waterline which table to use for our User model. The lower-case, plural name of the model
file will be used as the table name unless another name is explicitly specified. So, in this case, Waterline will
assume the User model stores records in the user table. You may specify a custom table by defining a tableName property
on your model:

```javascript
// path: app/models/user.js
var User = {
    tableName: 'my_users',

    attributes: {
       ...
    }
};

module.exports = User;
```

#### schema

```javascript
schema: true
```

A flag to toggle schemaless or schema mode in databases that support schemaless data structures. If turned off, this
will allow you to store arbitrary data in a record. If turned on, only attributes defined in the model's attributes
object will be stored.

For adapters that don't require a schema, such as Mongo or Redis, the default setting is `schema:false`.

#### connection

```javascript
connection: 'my-local-postgresql'
```
You may define a `connection` property to override the name of the database connection that should be used when
utilizing the model. Defaults to model.connection attribute specified in the configuration file `app/config/database.js`

#### autoPk

```javascript
autoPK: true
```

Waterline will define a primary key for each table by default.  The details of this default PK vary between
adapters (e.g. MySQL uses an auto-incrementing integer primary key, whereas MongoDB uses a randomized string UUID).In
any case, the primary keys generated by Waterline will be unique. You may define a `primaryKey` property to override
this convention or set attribute `autoPK` to false in your model.

#### autoUpdatedAt & autoCreatedAt

You will need to place updatedAt and createdAt columns on your table by default. If you do not wish to have these
columns automatically maintained, set the `autoUpdatedAt` and `autoCreatedAt` property on your model file to false.

#### identity

```javascript
identity: 'user'
```

The lowercase unique key for this model, e.g. user. By default, a model's identity is inferred automatically by
lowercasing its filename. All waterline models are attached to `app.models` object by identity as attribute. So you
can access a model like following:

```javascript
User = app.models.user // where user is the model identity
```

#### globalId

```javascript
globalId: 'User'
```

This flag changes the global name by which you can access your model (if the globalization of models is enabled). If
you do not specify a `globalId` attribute on your model model `identity` will be used as `globalId`

#### attributes

```javascript
attributes: {
  name: { type: 'string' },
  email: { type: 'email' },
  age: { type: 'integer' }
}
```

See [Model Attributes](Model Attributes).

### Retrieving All Models

```javascript
Model.find(function(err, users){
    //
});
```

### Retrieving A Record By Primary Key

```javascript
Model.findOne(1, function(err, user){
    console.log(user.name);
});
```

### Querying Using Waterline Models

```javascript
Model.find({ where: { name: 'foo' }, skip: 20, limit: 10, sort: 'name DESC' })
    .exec(function(err, users){
        //
    });
```

Find out more about querying [here](https://github.com/balderdashy/waterline-docs)

### Waterline Aggregates

```javascript
Model.count({ age: { '<': 30 }}, function(err, count) {
//
})

// Find the highest grossing movie by genre.
Movie.find()
    .groupBy('genre')
    .max('revenue')
    .then(function(results) {
        // Max revenue for the first genre.
        results[0].revenue;
    });
```

Some adapters, such as [sails-mysql](https://github.com/balderdashy/sails-mysql) and [sails-postgresql]
(https://github.com/balderdashy/sails-postgresql), support the query function which will run the provided RAW
query against the database. This can sometimes be useful if you want to run complex queries and performance is very
important.

```javascript
var title = "The King's Speech";
Movie.query('SELECT * FROM movie WHERE title = $1', [title], function(err, results) {
  // using sails-postgresql
  console.log('Found the following movie: ', results.rows[0]);

  // using sails-mysql
  console.log('Found the following movie: ', results[0]);
});
```

Find out more about aggregates [here](https://github.com/balderdashy/waterline-docs)

## Insert, Update, Delete

To create a new record in the database from a model, simply pass the arguments object to the model create method.

### Saving A New Record

```javascript
User.create({
  name: 'Walter Jr'
})
.exec(function(err, user) {});
```

After saving or creating a new record that uses auto-incrementing IDs, you may retrieve the ID by accessing the
object's id attribute:

```javascript
var insertedId = user.id;

// Retrieve the user by the attributes, or create it if it doesn't exist...
User.findOrCreate({ name: 'Walter Jr' })
.exec(function(err, users) {
//either user(s) with the name 'Walter Jr' get returned or
//a single user gets created with the name 'Walter Jr' and returned
});
```

### Updating A Record

To update records use the update method:

```javascript
//by criteria
User.update({name:'Walter Jr'},{name:'Flynn'}).exec(function afterwards(err, updated){

  if (err) {
    // handle error here- e.g. `res.serverError(err);`
    return;
  }

  console.log('Updated user to have name ' + updated[0].name);
});

//by primary key
User.update(78234,{name:'Flynn'}).exec(function afterwards(err, updated){

  if (err) {
    // handle error here- e.g. `res.serverError(err);`
    return;
  }

  console.log('Updated user to have name ' + updated[0].name);
});
```

### Deleting An Existing Record

To delete a record, simply call the destroy method on the model with criteria or primary key:

```javascript
User.destroy({ name: 'Flynn' })
.exec(function(err) {});

User.destroy(234)
.exec(function(err) {});
```

## Associations

Of course, your database tables are probably related to one another. For example, a blog post may have many comments,
or an order could be associated to the user who placed it. Waterline makes managing and working with these associations
easy. Waterline supports many types of associations:

 - [One To One](https://github.com/balderdashy/waterline-docs/blob/master/models/associations/one-to-one.md)
 - [One To Many](https://github.com/balderdashy/waterline-docs/blob/master/models/associations/one-to-many.md)
 - [Many To Many](https://github.com/balderdashy/waterline-docs/blob/master/models/associations/many-to-many.md)
 - [Dominance](https://github.com/balderdashy/waterline-docs/blob/master/models/associations/dominance.md)

## Querying Associations

`.populate( foreignKey, [query] )` a chainable method is used between .find()/.update() and .exec() in order to
retrieve records associated with the model being queried. You must supply the Foreign Key specified in your model
config.

```javascript
User.find({name:'Mike'}).exec(function(e,r){
  console.log(r[0].toJSON())
})

/*
{ name: 'Mike',
  age: 16,
  createdAt: Wed Feb 12 2014 18:06:50 GMT-0600 (CST),
  updatedAt: Wed Feb 12 2014 18:06:50 GMT-0600 (CST),
  id: 7 }
*/

User.find({name:'Mike'}).populate('pets').exec(function(e,r){
  console.log(r[0].toJSON())
});

/*
{ pets:
   [ { name: 'Pinkie Pie',
       color: 'pink',
       id: 7,
       createdAt: Wed Feb 12 2014 18:06:50 GMT-0600 (CST),
       updatedAt: Wed Feb 12 2014 18:06:50 GMT-0600 (CST) },
     { name: 'Rainbow Dash',
       color: 'blue',
       id: 8,
       createdAt: Wed Feb 12 2014 18:06:50 GMT-0600 (CST),
       updatedAt: Wed Feb 12 2014 18:06:50 GMT-0600 (CST) },
     { name: 'Applejack',
       color: 'orange',
       id: 9,
       createdAt: Wed Feb 12 2014 18:06:50 GMT-0600 (CST),
       updatedAt: Wed Feb 12 2014 18:06:50 GMT-0600 (CST) } ],
  name: 'Mike',
  age: 16,
  createdAt: Wed Feb 12 2014 18:06:50 GMT-0600 (CST),
  updatedAt: Wed Feb 12 2014 18:06:50 GMT-0600 (CST),
  id: 7 }
*/

User.find({name:'Mike'}).populate('pets',{color:'pink'}).exec(function(e,r){
  console.log(r[0].toJSON())
});

/*
{ pets:
   [ { name: 'Pinkie Pie',
       color: 'pink',
       id: 7,
       createdAt: Wed Feb 12 2014 18:06:50 GMT-0600 (CST),
       updatedAt: Wed Feb 12 2014 18:06:50 GMT-0600 (CST) }],
  name: 'Mike',
  age: 16,
  createdAt: Wed Feb 12 2014 18:06:50 GMT-0600 (CST),
  updatedAt: Wed Feb 12 2014 18:06:50 GMT-0600 (CST),
  id: 7 }
*/
```